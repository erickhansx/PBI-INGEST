# MVH Broadband DIA Project Configuration
# Configuración para el proyecto de reconciliación de cotizaciones de Broadband y DIA
# 
# DESIGN PRINCIPLES:
# - MATCH: Datos coinciden exactamente (o dentro de tolerancia configurada)
# - MISMATCH: Hay valor en ambos lados y NO coinciden
# - MISSING_IN_PBI: Existe en source original, NO existe en modelo PBI
# - MISSING_IN_SOURCE: Existe en modelo PBI, NO existe en source original
# - NOT_VERIFIABLE: No hay datos suficientes para realizar la comparación
# - RULE_NOT_DEFINED: No existe regla/mapeo configurado para ese campo
#
# NUNCA asumir. Si no hay regla → RULE_NOT_DEFINED. Si no hay datos → NOT_VERIFIABLE.

project:
  name: 'mvh'
  version: '1.0.0'
  description: 'Validación de datos PBI contra fuentes SharePoint para proyecto MVH'

# Rutas base
paths:
  sources_base: 'C:/Users/mak_m/Downloads/PBIX-RECONCILIATION'
  pbi_model: 'C:/Users/mak_m/Downloads/PBIX-RECONCILIATION/pbix_unpacked'
  reports_output: './reports'

# Configuración global
settings:
  default_encoding: 'utf-8'
  numeric_tolerance: 0.01  # $0.01 de tolerancia para comparaciones de precios

# Definición de fuentes de datos
sources:
  # Tablas PBI Model
  fact_quotes:
    path: 'factQuotes.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Site_Location_Key', 'Service_Type', 'Vendor']

  dim_site:
    path: 'dimSite.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Site_Location_Key']

  dim_service_type:
    path: 'dimServiceType.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Service_Type']

  fact_existing_costs:
    path: 'factExistingCosts.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Site_Location_Key']

  fact_serviceability:
    path: 'factServiceability Matrix.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Site_Location_Key']

  # Fuentes SharePoint (archivos source originales)
  sharepoint_arch1:
    path: 'Broadband DIA_Archetype 1_sharepoint.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Site_Location_Key']

  sharepoint_arch2:
    path: 'Broadband DIA_Archetype 2_sharepoint.csv'
    type: 'csv'
    encoding: 'utf-8'
    delimiter: ','
    key_columns: ['Site_Location_Key']

# Reglas de validación por Service Type
# Cada regla define qué campos comparar entre source y PBI
validation_rules:
  # Broadband: El MRC viene del campo "Broadband Circuit MRC $/Month" en SharePoint
  Broadband:
    source_name: 'sharepoint_arch1'  # O arch2, dependiendo del Archtype
    source_filters:
      # Opcional: filtros adicionales para el source
    pbi_filters:
      Service_Type: 'Broadband'
    field_mappings:
      - source_field: 'Broadband Circuit MRC $/Month'
        pbi_field: 'Total MRC'
        compare_type: 'numeric'
        tolerance: 0.01
      - source_field: 'Vendor'
        pbi_field: 'Vendor'
        compare_type: 'exact'

  # DIA: Tiene campos específicos diferentes
  # NOTA: Si user reporta $933.48 y no hay campo exacto → NOT_VERIFIABLE
  DIA:
    source_name: 'sharepoint_arch1'
    source_filters: {}
    pbi_filters:
      Service_Type: 'DIA'
    field_mappings:
      - source_field: 'DIA Circuit MRC $/Month'
        pbi_field: 'Total MRC'
        compare_type: 'numeric'
        tolerance: 0.01
      - source_field: 'Vendor'
        pbi_field: 'Vendor'
        compare_type: 'exact'

  # CPE: RULE_NOT_DEFINED - no existe en dimServiceType
  # Mantenemos la regla pero el validador marcará RULE_NOT_DEFINED si no hay datos
  CPE:
    source_name: 'sharepoint_arch1'
    source_filters: {}
    pbi_filters:
      Service_Type: 'CPE'
    field_mappings:
      - source_field: 'CPE Recurring - Primary DIA'
        pbi_field: 'Total MRC'
        compare_type: 'numeric'
        tolerance: 0.01

  # LTE: Similar a CPE
  LTE:
    source_name: 'sharepoint_arch1'
    source_filters: {}
    pbi_filters:
      Service_Type: 'LTE'
    field_mappings:
      - source_field: 'LTE MRC $/Month'
        pbi_field: 'Total MRC'
        compare_type: 'numeric'
        tolerance: 0.01

# Verificaciones de integridad referencial
integrity_checks:
  - name: 'fact_quotes_to_dim_site'
    source_table: 'fact_quotes'
    target_table: 'dim_site'
    source_key: 'Site_Location_Key'
    target_key: 'Site_Location_Key'
    severity: 'WARNING'

  - name: 'fact_quotes_to_dim_service_type'
    source_table: 'fact_quotes'
    target_table: 'dim_service_type'
    source_key: 'Service_Type'
    target_key: 'Service_Type'
    severity: 'WARNING'

  - name: 'fact_existing_costs_to_dim_site'
    source_table: 'fact_existing_costs'
    target_table: 'dim_site'
    source_key: 'Site_Location_Key'
    target_key: 'Site_Location_Key'
    severity: 'ERROR'
